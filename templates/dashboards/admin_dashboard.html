{% extends "admin_base.html" %}

{% block title %}Admin Dashboard - KNEC EMS{% endblock %}

{% block extra_css %}
<style>
    /* Professional Color Scheme */
    :root {
        --primary-blue: #2c5aa0;
        --secondary-blue: #3a6bc0;
        --accent-green: #28a745;
        --accent-orange: #fd7e14;
        --accent-purple: #6f42c1;
        --accent-red: #dc3545;
        --text-primary: #2c3e50;
        --text-secondary: #6c757d;
        --border-light: #e9ecef;
        --bg-light: #f8f9fa;
    }

    .stat-card {
        background: white;
        border: 1px solid var(--border-light);
        border-radius: 6px;
        padding: 1.25rem;
        height: 100%;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-blue);
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-color: var(--secondary-blue);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        margin-bottom: 1rem;
        border-radius: 6px;
        background: var(--bg-light);
        color: var(--primary-blue);
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        line-height: 1.2;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .stat-change {
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-weight: 500;
    }

    .stat-change.positive {
        color: var(--accent-green);
    }

    .stat-change.negative {
        color: var(--accent-red);
    }

    .chart-card {
        background: white;
        border: 1px solid var(--border-light);
        border-radius: 6px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.2s ease;
    }

    .chart-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-light);
    }

    .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .chart-subtitle {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    .chart-actions {
        display: flex;
        gap: 0.5rem;
    }

    .chart-action-btn {
        background: var(--bg-light);
        border: 1px solid var(--border-light);
        border-radius: 4px;
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .chart-action-btn:hover {
        background: var(--primary-blue);
        border-color: var(--primary-blue);
        color: white;
    }

    .activity-item {
        display: flex;
        gap: 1rem;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-light);
        transition: background-color 0.2s;
    }

    .activity-item:hover {
        background-color: var(--bg-light);
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-light);
        color: var(--primary-blue);
        border-radius: 6px;
        flex-shrink: 0;
        font-size: 1rem;
    }

    .activity-content {
        flex: 1;
    }

    .activity-title {
        font-size: 0.9rem;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        font-weight: 500;
    }

    .activity-meta {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .task-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.875rem 0;
        border-bottom: 1px solid var(--border-light);
        transition: background-color 0.2s;
    }

    .task-item:hover {
        background-color: var(--bg-light);
    }

    .task-item:last-child {
        border-bottom: none;
    }

    .task-label {
        font-size: 0.9rem;
        color: var(--text-primary);
        font-weight: 500;
    }

    .task-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.75rem;
        background: var(--accent-red);
        color: white;
        font-weight: 600;
        border-radius: 12px;
    }

    .quick-action-btn {
        width: 100%;
        padding: 1.25rem 0.75rem;
        background: white;
        border: 1px solid var(--border-light);
        border-radius: 6px;
        text-align: center;
        text-decoration: none;
        color: var(--text-primary);
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .quick-action-btn:hover {
        background: var(--primary-blue);
        border-color: var(--primary-blue);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(44, 90, 160, 0.2);
    }

    .quick-action-icon {
        font-size: 1.5rem;
    }

    /* Secondary stats cards */
    .secondary-stat-card {
        background: white;
        border: 1px solid var(--border-light);
        border-radius: 6px;
        padding: 1rem;
        text-align: center;
        transition: all 0.2s ease;
    }

    .secondary-stat-card:hover {
        border-color: var(--primary-blue);
        transform: translateY(-1px);
    }

    .secondary-stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .secondary-stat-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* Alert styling for fraud cards */
    .fraud-alert .secondary-stat-value {
        color: var(--accent-red);
    }

    /* Content header improvements */
    .content-card {
        background: white;
        border: 1px solid var(--border-light);
        border-radius: 6px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .content-title {
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    /* Button improvements */
    .btn-outline-primary {
        border-color: var(--primary-blue);
        color: var(--primary-blue);
    }

    .btn-outline-primary:hover {
        background: var(--primary-blue);
        border-color: var(--primary-blue);
    }

    .btn-primary {
        background: var(--primary-blue);
        border-color: var(--primary-blue);
    }

    .btn-primary:hover {
        background: var(--secondary-blue);
        border-color: var(--secondary-blue);
    }

    /* Grid improvements */
    .row.g-3 {
        margin-left: -0.75rem;
        margin-right: -0.75rem;
    }

    .row.g-3 > [class*="col-"] {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
    }

    /* Empty state styling */
    .empty-state {
        padding: 2rem 1rem;
        text-align: center;
        color: var(--text-secondary);
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
        .stat-value {
            font-size: 1.5rem;
        }
        
        .chart-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .chart-actions {
            align-self: flex-end;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="content-card">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="content-title mb-2">Admin Dashboard</h1>
            <p class="text-muted mb-0">
                <i class="bi bi-calendar3 me-2"></i>
                {% if active_year %}{{ active_year.year }}{% else %}No Active Year{% endif %}
                <span class="mx-2">•</span>
                <i class="bi bi-clock me-2"></i>
                Last updated: {{ now|date:"d M Y, H:i" }}
            </p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary">
                <i class="bi bi-download me-2"></i>
                Export Report
            </button>
            <button class="btn btn-primary">
                <i class="bi bi-arrow-clockwise me-2"></i>
                Refresh
            </button>
        </div>
    </div>
</div>

<!-- Primary Statistics Cards -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-people-fill"></i>
            </div>
            <div class="stat-value">{{ total_users|default:"0" }}</div>
            <div class="stat-label">Total Users</div>
            <div class="stat-change positive">
                <i class="bi bi-arrow-up"></i>
                <span>12% from last month</span>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-building"></i>
            </div>
            <div class="stat-value">{{ total_schools|default:"0" }}</div>
            <div class="stat-label">Registered Schools</div>
            <div class="stat-change positive">
                <i class="bi bi-arrow-up"></i>
                <span>8% from last month</span>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-person-lines-fill"></i>
            </div>
            <div class="stat-value">{{ total_candidates|default:"0" }}</div>
            <div class="stat-label">Total Candidates</div>
            <div class="stat-change positive">
                <i class="bi bi-arrow-up"></i>
                <span>{{ current_year_candidates|default:"0" }} this year</span>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-cash-stack"></i>
            </div>
            <div class="stat-value">KES {{ total_revenue|floatformat:0|default:"0" }}</div>
            <div class="stat-label">Total Revenue</div>
            <div class="stat-change positive">
                <i class="bi bi-arrow-up"></i>
                <span>{{ recent_payments|default:"0" }} payments (30d)</span>
            </div>
        </div>
    </div>
</div>

<!-- Secondary Stats -->
<div class="row g-3 mb-4">
    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="secondary-stat-card">
            <div class="secondary-stat-value">{{ released_results|default:"0" }}</div>
            <div class="secondary-stat-label">Released Results</div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="secondary-stat-card">
            <div class="secondary-stat-value">{{ pending_results|default:"0" }}</div>
            <div class="secondary-stat-label">Pending Results</div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="secondary-stat-card">
            <div class="secondary-stat-value">{{ knec_staff|default:"0" }}</div>
            <div class="secondary-stat-label">KNEC Staff</div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="secondary-stat-card">
            <div class="secondary-stat-value">{{ marks_entry_clerks|default:"0" }}</div>
            <div class="secondary-stat-label">Marks Entry</div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="secondary-stat-card fraud-alert">
            <div class="secondary-stat-value">{{ unresolved_fraud|default:"0" }}</div>
            <div class="secondary-stat-label">Fraud Alerts</div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="secondary-stat-card">
            <div class="secondary-stat-value">{{ school_users|default:"0" }}</div>
            <div class="secondary-stat-label">School Users</div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row g-3 mb-4">
    <div class="col-lg-8">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <h3 class="chart-title">Candidate Registration Trend</h3>
                    <p class="chart-subtitle">Last 6 months</p>
                </div>
                <div class="chart-actions">
                    <button class="chart-action-btn" title="Download">
                        <i class="bi bi-download"></i>
                    </button>
                    <button class="chart-action-btn" title="More options">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                </div>
            </div>
            <canvas id="candidatesTrendChart" height="80"></canvas>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <h3 class="chart-title">User Distribution</h3>
                    <p class="chart-subtitle">By user type</p>
                </div>
            </div>
            <canvas id="userDistributionChart" height="200"></canvas>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row g-3 mb-4">
    <div class="col-lg-6">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <h3 class="chart-title">Grade Distribution</h3>
                    <p class="chart-subtitle">Overall performance</p>
                </div>
                <div class="chart-actions">
                    <button class="chart-action-btn" title="Download">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
            </div>
            <canvas id="gradeDistributionChart" height="100"></canvas>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <h3 class="chart-title">Results by Education Level</h3>
                    <p class="chart-subtitle">Released results count</p>
                </div>
                <div class="chart-actions">
                    <button class="chart-action-btn" title="Download">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
            </div>
            <canvas id="resultsLevelChart" height="100"></canvas>
        </div>
    </div>
</div>

<!-- Charts Row 3 -->
<div class="row g-3 mb-4">
    <div class="col-lg-8">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <h3 class="chart-title">Payment Trends</h3>
                    <p class="chart-subtitle">Revenue over last 30 days</p>
                </div>
                <div class="chart-actions">
                    <button class="chart-action-btn" title="Download">
                        <i class="bi bi-download"></i>
                    </button>
                </div>
            </div>
            <canvas id="paymentTrendChart" height="80"></canvas>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <h3 class="chart-title">Top Performing Schools</h3>
                    <p class="chart-subtitle">Mean score ranking</p>
                </div>
            </div>
            <canvas id="topSchoolsChart" height="200"></canvas>
        </div>
    </div>
</div>

<!-- Activity and Tasks -->
<div class="row g-3">
    <div class="col-lg-6">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <h3 class="chart-title">Recent Activities</h3>
                    <p class="chart-subtitle">System activity log</p>
                </div>
                <a href="#" class="text-decoration-none small fw-medium">
                    View All <i class="bi bi-arrow-right ms-1"></i>
                </a>
            </div>
            <div>
                {% for activity in recent_activities %}
                <div class="activity-item">
                    <div class="activity-icon">
                        <i class="bi bi-{% if activity.action == 'LOGIN' %}box-arrow-in-right{% elif activity.action == 'CREATE' %}plus-circle{% elif activity.action == 'UPDATE' %}pencil{% elif activity.action == 'DELETE' %}trash{% else %}activity{% endif %}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">{{ activity.get_action_display }}</div>
                        <div class="activity-meta">
                            {% if activity.user %}{{ activity.user.get_full_name }}{% else %}System{% endif %} • 
                            {{ activity.timestamp|timesince }} ago
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <i class="bi bi-activity fs-4 text-muted mb-2"></i>
                    <p class="mb-0">No recent activities</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <h3 class="chart-title">Pending Tasks</h3>
                    <p class="chart-subtitle">Requires attention</p>
                </div>
            </div>
            <div>
                <div class="task-item">
                    <span class="task-label">
                        <i class="bi bi-file-earmark-check me-2"></i>
                        Unverified Birth Certificates
                    </span>
                    <span class="task-badge">{{ pending_tasks.unverified_certificates }}</span>
                </div>
                <div class="task-item">
                    <span class="task-label">
                        <i class="bi bi-list-check me-2"></i>
                        Pending Results Release
                    </span>
                    <span class="task-badge">{{ pending_tasks.pending_results }}</span>
                </div>
                <div class="task-item">
                    <span class="task-label">
                        <i class="bi bi-shield-exclamation me-2"></i>
                        Unresolved Fraud Attempts
                    </span>
                    <span class="task-badge">{{ pending_tasks.unresolved_fraud }}</span>
                </div>
                <div class="task-item">
                    <span class="task-label">
                        <i class="bi bi-person-x me-2"></i>
                        Expired Accounts
                    </span>
                    <span class="task-badge">{{ pending_tasks.expired_accounts }}</span>
                </div>
            </div>
        </div>

        <div class="chart-card mt-3">
            <div class="chart-header">
                <div>
                    <h3 class="chart-title">Quick Actions</h3>
                </div>
            </div>
            <div class="row g-2">
                <div class="col-6">
                    <a href="#" class="quick-action-btn">
                        <div class="quick-action-icon"><i class="bi bi-person-plus"></i></div>
                        <div>Add User</div>
                    </a>
                </div>
                <div class="col-6">
                    <a href="#" class="quick-action-btn">
                        <div class="quick-action-icon"><i class="bi bi-building"></i></div>
                        <div>Add School</div>
                    </a>
                </div>
                <div class="col-6">
                    <a href="#" class="quick-action-btn">
                        <div class="quick-action-icon"><i class="bi bi-unlock"></i></div>
                        <div>Release Results</div>
                    </a>
                </div>
                <div class="col-6">
                    <a href="#" class="quick-action-btn">
                        <div class="quick-action-icon"><i class="bi bi-graph-up"></i></div>
                        <div>View Reports</div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    // Parse data from Django
    const candidatesByMonth = {{ candidates_by_month_json|safe }};
    const resultsByLevel = {{ results_by_level_json|safe }};
    const gradesData = {{ grades_data_json|safe }};
    const topSchools = {{ top_schools_json|safe }};
    const activityByDay = {{ activity_by_day_json|safe }};
    const paymentByDay = {{ payment_by_day_json|safe }};
    const userTypeDistribution = {{ user_type_distribution_json|safe }};

    // Chart.js default config
    Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
    Chart.defaults.color = '#6c757d';

    // Professional color palette
    const colors = {
        primary: '#2c5aa0',
        secondary: '#3a6bc0',
        success: '#28a745',
        warning: '#fd7e14',
        danger: '#dc3545',
        info: '#6f42c1'
    };

    // 1. Candidates Trend Chart
    new Chart(document.getElementById('candidatesTrendChart'), {
        type: 'line',
        data: {
            labels: candidatesByMonth.map(d => d.month),
            datasets: [{
                label: 'Registrations',
                data: candidatesByMonth.map(d => d.count),
                borderColor: colors.primary,
                backgroundColor: 'rgba(44, 90, 160, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                x: { 
                    grid: { display: false }
                }
            }
        }
    });

    // 2. User Distribution Chart
    new Chart(document.getElementById('userDistributionChart'), {
        type: 'doughnut',
        data: {
            labels: userTypeDistribution.map(d => d.type),
            datasets: [{
                data: userTypeDistribution.map(d => d.count),
                backgroundColor: [colors.primary, colors.info, colors.danger, colors.warning],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: { padding: 15 }
                }
            },
            cutout: '65%'
        }
    });

    // 3. Grade Distribution Chart
    new Chart(document.getElementById('gradeDistributionChart'), {
        type: 'bar',
        data: {
            labels: gradesData.map(d => d.grade),
            datasets: [{
                label: 'Students',
                data: gradesData.map(d => d.count),
                backgroundColor: colors.primary,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                x: { 
                    grid: { display: false }
                }
            }
        }
    });

    // 4. Results by Level Chart
    new Chart(document.getElementById('resultsLevelChart'), {
        type: 'bar',
        data: {
            labels: resultsByLevel.map(d => d.level),
            datasets: [{
                label: 'Results',
                data: resultsByLevel.map(d => d.count),
                backgroundColor: [colors.primary, colors.info, colors.warning],
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'y',
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { 
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                y: { 
                    grid: { display: false }
                }
            }
        }
    });

    // 5. Payment Trend Chart
    new Chart(document.getElementById('paymentTrendChart'), {
        type: 'line',
        data: {
            labels: paymentByDay.map(d => d.date),
            datasets: [{
                label: 'Revenue (KES)',
                data: paymentByDay.map(d => d.amount),
                borderColor: colors.success,
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                x: { 
                    grid: { display: false }
                }
            }
        }
    });

    // 6. Top Schools Chart
    if (topSchools.length > 0) {
        new Chart(document.getElementById('topSchoolsChart'), {
            type: 'bar',
            data: {
                labels: topSchools.map(d => d.school.substring(0, 15) + '...'),
                datasets: [{
                    label: 'Mean Score',
                    data: topSchools.map(d => d.mean_score),
                    backgroundColor: colors.warning,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { 
                        beginAtZero: true, 
                        max: 100,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: { 
                        grid: { display: false }
                    }
                }
            }
        });
    }
</script>
{% endblock %}